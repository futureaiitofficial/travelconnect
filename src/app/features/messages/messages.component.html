<div class="messages-container">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-overlay">
      <div class="loading-spinner"></div>
      <p>Loading messages...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-banner">
      <p>{{ error() }}</p>
      <button (click)="loadConversations()" class="retry-btn">Retry</button>
    </div>
  }

  <!-- Main Messages Layout -->
  <div class="messages-layout">
    <!-- Conversations Sidebar -->
    <div class="conversations-sidebar">
      <!-- Header -->
      <div class="sidebar-header">
        <div class="header-content">
          <div class="user-profile">
            <img
              [src]="getUserAvatarUrl(currentUser() || { _id: '', username: '', fullName: '', profilePicture: '' })"
              [alt]="currentUser()?.fullName"
              class="user-avatar"
            >
            <h2>{{ currentUser()?.username }}</h2>
          </div>
          <div class="header-actions">
            <button (click)="toggleSearch()" class="icon-btn" [class.active]="showSearch()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </button>
            <button (click)="toggleNewConversation()" class="icon-btn">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Search Bar -->
        @if (showSearch()) {
          <div class="search-bar">
            <div class="search-input-wrapper">
              <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <input
                type="text"
                placeholder="Search..."
                [value]="searchQuery()"
                (input)="searchQuery.set($any($event.target).value)"
                class="search-input"
              >
            </div>
          </div>
        }
      </div>

      <!-- Conversations List -->
      <div class="conversations-list">
        @if (filteredConversations().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
              </svg>
            </div>
            <h3>Your Messages</h3>
            <p>Send private photos and messages to a friend or group</p>
            <button (click)="toggleNewConversation()" class="btn btn-primary">
              Send Message
            </button>
          </div>
        } @else {
          @for (conversation of filteredConversations(); track conversation._id) {
            <div
              class="conversation-item"
              [class.active]="activeConversation()?._id === conversation._id"
              (click)="selectConversation(conversation)"
            >
              <div class="conversation-avatar">
                <img
                  [src]="getUserAvatarUrl(conversation.members[0])"
                  [alt]="messageService.getConversationDisplayName(conversation, currentUser()?._id || '')"
                  class="avatar"
                >
                @if (conversation.unreadCount && conversation.unreadCount > 0) {
                  <div class="unread-badge">{{ conversation.unreadCount }}</div>
                }
              </div>

              <div class="conversation-content">
                <div class="conversation-header">
                  <h4 class="conversation-name">
                    {{ messageService.getConversationDisplayName(conversation, currentUser()?.id || '') }}
                  </h4>
                  <span class="conversation-time">{{ getConversationTime(conversation) }}</span>
                </div>

                <div class="conversation-preview">
                  <p class="last-message">
                    @if (conversation.lastMessageBy?._id === currentUser()?.id) {
                      <span class="you-indicator">You: </span>
                    }
                    {{ conversation.lastMessage || 'No messages yet' }}
                  </p>
                </div>
              </div>
            </div>
          }
        }
      </div>
    </div>

    <!-- Messages Area -->
    <div class="messages-area">
      @if (!activeConversation()) {
        <!-- No Conversation Selected -->
        <div class="no-conversation">
          <div class="no-conversation-content">
            <div class="no-conversation-icon">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
              </svg>
            </div>
            <h3>Your Messages</h3>
            <p>Send photos and messages to friends</p>
            <button (click)="toggleNewConversation()" class="btn btn-primary">
              Send Message
            </button>
          </div>
        </div>
      } @else {
        <!-- Active Conversation -->
        <div class="conversation-header">
          <div class="conversation-info">
            <img
              [src]="activeConversationAvatar()"
              [alt]="activeConversationDisplayName()"
              class="conversation-avatar"
            >
            <div class="conversation-details">
              <h3>{{ activeConversationDisplayName() }}</h3>
                              @if (activeConversation()?.isGroup) {
                  <p class="member-count">{{ activeConversation()?.members?.length || 0 }} members</p>
                } @else {
                <p class="online-status">Active now</p>
              }
            </div>
          </div>

          <div class="conversation-actions">
            <button class="icon-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
              </svg>
            </button>
            <button class="icon-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
              </svg>
            </button>
            <button class="icon-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Messages List -->
        <div class="messages-list" #messagesArea>
          @if (hasMoreMessages()) {
            <div class="load-more-container">
              <button (click)="loadMoreMessages()" class="load-more-btn">
                Load more messages
              </button>
            </div>
          }

          @for (message of messages(); track message._id) {
            <div
              class="message-container"
              [class.own-message]="isCurrentUserMessage(message)"
              (click)="markMessageAsRead(message)"
            >
              @if (!isCurrentUserMessage(message)) {
                <img
                  [src]="getUserAvatarUrl(message.senderId)"
                  [alt]="message.senderId.fullName"
                  class="message-avatar"
                >
              }

              <div class="message-content">
                @if (message.replyTo) {
                  <div class="reply-to">
                    <p class="reply-text">{{ message.replyTo.messageText }}</p>
                  </div>
                }

                <div class="message-bubble">
                  <p class="message-text">{{ message.messageText }}</p>

                  @if (message.mediaUrl) {
                    <div class="message-media">
                      <img [src]="message.mediaUrl" [alt]="message.messageText" class="media-image">
                    </div>
                  }

                  <div class="message-footer">
                    <span class="message-time">{{ getMessageTime(message) }}</span>

                    @if (isCurrentUserMessage(message)) {
                      <div class="message-status">
                        @if (message.read) {
                          <svg class="read-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                          </svg>
                        } @else {
                          <svg class="sent-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                          </svg>
                        }
                      </div>
                    }
                  </div>
                </div>

                @if (message.reactions.length > 0) {
                  <div class="message-reactions">
                    @for (reaction of message.reactions; track reaction.user._id + reaction.emoji) {
                      <span class="reaction">{{ reaction.emoji }}</span>
                    }
                  </div>
                }

                <!-- Message Actions -->
                <div class="message-actions">
                  <button (click)="addReaction(message, '❤️')" class="action-btn">❤️</button>
                  <button (click)="addReaction(message, '👍')" class="action-btn">👍</button>
                  <button (click)="addReaction(message, '😊')" class="action-btn">😊</button>
                  @if (isCurrentUserMessage(message)) {
                    <button (click)="deleteMessage(message)" class="action-btn delete">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
          <div class="input-wrapper">
            <button class="attachment-btn">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
              </svg>
            </button>

            <div class="input-area">
              <textarea
                #messageInput
                [value]="newMessage()"
                (input)="onMessageInput($event)"
                (keypress)="onMessageKeyPress($event)"
                placeholder="Message..."
                class="message-input"
                rows="1"
              ></textarea>
            </div>

            <button
              (click)="sendMessage()"
              class="send-btn"
              [disabled]="!newMessage().trim()"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- New Conversation Modal -->
  @if (showNewConversation()) {
    <div class="modal-overlay" (click)="toggleNewConversation()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>New Message</h3>
          <button (click)="toggleNewConversation()" class="close-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          <!-- Chat Type Toggle -->
          <div class="chat-type-toggle">
            <button
              (click)="isGroupChat.set(false)"
              class="toggle-btn"
              [class.active]="!isGroupChat()"
            >
              Direct Message
            </button>
            <button
              (click)="isGroupChat.set(true)"
              class="toggle-btn"
              [class.active]="isGroupChat()"
            >
              Group Chat
            </button>
          </div>

          @if (isGroupChat()) {
            <!-- Group Name Input -->
            <div class="form-group">
              <label>Group Name</label>
              <input
                type="text"
                [value]="groupName()"
                (input)="groupName.set($any($event.target).value)"
                placeholder="Enter group name..."
                class="form-input"
              >
            </div>
          }

                    <!-- User Selection -->
          <div class="form-group">
            <label>{{ isGroupChat() ? 'Add Members' : 'Select User' }}</label>

            @if (selectedUsers().length > 0) {
              <div class="selected-users">
                @for (user of selectedUsers(); track user._id) {
                  <div class="selected-user">
                    <img [src]="getUserAvatarUrl(user)" [alt]="user.fullName" class="user-avatar">
                    <span>{{ user.fullName }}</span>
                    <button (click)="removeSelectedUser(user._id)" class="remove-btn">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            }

            <!-- User Search -->
            <div class="user-search">
              <div class="search-input-wrapper">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
                <input
                  type="text"
                  placeholder="Search users..."
                  [value]="searchUsersQuery()"
                  (input)="searchUsersQuery.set($any($event.target).value); searchUsers()"
                  class="search-input"
                >
              </div>
            </div>

            <!-- User Search Results -->
            @if (searchingUsers()) {
              <div class="searching-indicator">
                <div class="loading-spinner"></div>
                <span>Searching users...</span>
              </div>
            } @else if (searchUsersResults().length > 0) {
              <div class="user-list">
                @for (user of searchUsersResults(); track user._id) {
                  <div class="user-item" (click)="addSelectedUser(user)">
                    <img [src]="getUserAvatarUrl(user)" [alt]="user.fullName" class="user-avatar">
                    <div class="user-info">
                      <h4>{{ user.fullName }}</h4>
                      <p>@{{ user.username }}</p>
                    </div>
                  </div>
                }
              </div>
            } @else if (searchUsersQuery() && searchUsersQuery().length >= 2) {
              <div class="no-results">
                <p>No users found</p>
              </div>
            }
          </div>
        </div>

        <div class="modal-footer">
          <button (click)="toggleNewConversation()" class="btn btn-secondary">
            Cancel
          </button>
          <button
            (click)="createNewConversation()"
            class="btn btn-primary"
            [disabled]="selectedUsers().length === 0 || (isGroupChat() && !groupName())"
          >
            {{ isGroupChat() ? 'Create Group' : 'Start Chat' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
